<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êñ∞Âä†Âù°Â§©Ê∞î‰∫ëÂõæ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .base-map {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 1;
        }

        .cloud-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 3;
            opacity: 0.5;
        }

        .time-controls {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 8px;
            color: white;
            z-index: 10;
            min-width: 250px;
            max-width: 250px;
            backdrop-filter: blur(10px);
        }

        .time-display {
            text-align: center;
            margin-bottom: 4px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .datetime-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .date-text {
            min-width: 90px;
        }

        .time-text {
            min-width: 50px;
        }

        .date-picker {
            min-width: 90px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            color: white;
            padding: 2px 4px;
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            outline: none;
        }

        .date-picker::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .date-picker::-webkit-datetime-edit {
            color: white;
        }

        .date-picker::-webkit-datetime-edit-fields-wrapper {
            color: white;
        }

        .control-buttons {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }

        .location-error-message {
            text-align: center;
            margin-bottom: 4px;
            font-size: 12px;
            font-weight: 500;
            color: #ff0000;
            display: none;
        }

        .slider-container {
            position: relative;
            margin-bottom: 8px;
        }

        .time-slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .time-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }


        .control-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 4px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
            min-width: 24px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: #45a049;
        }

        .control-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .overlay-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            justify-content: center;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: white;
            cursor: pointer;
            user-select: none;
        }

        .overlay-checkbox {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .overlay-image {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 2;
            pointer-events: none;
        }

        .user-location {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #2196F3;
            border: 2px solid white;
            border-radius: 50%;
            z-index: 4;
            pointer-events: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transform: translate(-50%, -50%);
        }

        .credit-link {
            margin-top: 6px;
            text-align: center;
        }

        .credit-link a {
            color: #888;
            text-decoration: none;
            font-size: 9px;
            transition: color 0.3s;
        }

        .credit-link a:hover {
            color: #ccc;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            z-index: 5;
        }

        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 5;
            max-width: 80%;
        }

        /* ÁßªÂä®Á´Ø‰ºòÂåñ */
        @media (max-width: 768px) {
            .time-controls {
                bottom: 8px;
                right: 8px;
                left: auto;
                min-width: auto;
                max-width: 250px;
                padding: 8px;
            }

            .time-display {
                font-size: 11px;
            }

            .datetime-container {
                gap: 4px;
            }

            .date-text {
                min-width: 75px;
                font-size: 11px;
            }

            .time-text {
                min-width: 45px;
                font-size: 11px;
            }

            .date-picker {
                min-width: 75px;
                font-size: 11px;
                padding: 2px 3px;
            }

            .location-error-message {
                font-size: 11px;
            }

            .control-btn {
                padding: 3px 5px;
                font-size: 11px;
                min-width: 20px;
                height: 18px;
            }

            .overlay-controls {
                gap: 6px;
                margin-top: 6px;
            }

            .checkbox-label {
                font-size: 10px;
            }

            .overlay-checkbox {
                width: 12px;
                height: 12px;
            }

            .credit-link a {
                font-size: 8px;
            }
        }

        /* Ê®™Â±è‰ºòÂåñ */
        @media (orientation: landscape) and (max-height: 500px) {
            .time-controls {
                bottom: 5px;
                right: 5px;
                left: auto;
                padding: 6px;
                min-width: 200px;
                max-width: 250px;
            }

            .time-display {
                font-size: 10px;
                margin-bottom: 2px;
            }

            .datetime-container {
                gap: 3px;
            }

            .date-text {
                min-width: 70px;
                font-size: 10px;
            }

            .time-text {
                min-width: 40px;
                font-size: 10px;
            }

            .date-picker {
                min-width: 70px;
                font-size: 10px;
                padding: 1px 2px;
            }

            .location-error-message {
                font-size: 10px;
            }

            .control-buttons {
                gap: 4px;
            }

            .control-btn {
                padding: 2px 4px;
                font-size: 10px;
                min-width: 18px;
                height: 16px;
            }

            .overlay-controls {
                gap: 4px;
                margin-top: 4px;
            }

            .checkbox-label {
                font-size: 9px;
            }

            .overlay-checkbox {
                width: 10px;
                height: 10px;
            }

            .credit-link a {
                font-size: 7px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="map-container">
            <img id="baseMap" class="base-map" src="https://www.weather.gov.sg/wp-content/themes/wiptheme/assets/img/base-853.png" alt="Êñ∞Âä†Âù°Â∫ïÂõæ">
            <img id="mrtOverlay" class="overlay-image" alt="MRTÁ∫øË∑Ø" style="display: none;">
            <img id="hiwOverlay" class="overlay-image" alt="È´òÈÄüÂÖ¨Ë∑Ø" style="display: none;">
            <img id="ldmkOverlay" class="overlay-image" alt="Âú∞Ê†á" style="display: none;">
            <img id="townOverlay" class="overlay-image" alt="ÂüéÈïá" style="display: none;">
            <img id="cloudOverlay" class="cloud-overlay" alt="‰∫ëÂõæË¶ÜÁõñÂ±Ç">
            <div id="userLocation" class="user-location" style="display: none;"></div>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            Âä†ËΩΩ‰∏≠...
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;">
            Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•
        </div>
    </div>

    <div class="time-controls">
        <div class="time-display" id="timeDisplay">
            <div class="datetime-container">
                <span class="date-text" id="dateText">2025-09-11</span>
                <input type="date" id="datePicker" class="date-picker" style="display: none;" min="2025-11-01">
                <span class="time-text" id="timeText">15:15</span>
            </div>
            <div class="control-buttons">
                <button id="playBtn" class="control-btn">‚ñ∂</button>
                <button id="pauseBtn" class="control-btn" style="display: none;">‚è∏</button>
                <button id="historyBtn" class="control-btn" title="Êü•ÁúãÂéÜÂè≤‰∫ëÂõæ">üìÜ</button>
            </div>
        </div>
        <div class="slider-container">
            <input type="range" id="timeSlider" class="time-slider" min="0" max="24" value="24">
        </div>
        <div class="overlay-controls">
            <label class="checkbox-label">
                <input type="checkbox" id="mrtCheckbox" class="overlay-checkbox">
                <span>MRT</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" id="hiwCheckbox" class="overlay-checkbox">
                <span>HiW</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" id="ldmkCheckbox" class="overlay-checkbox">
                <span>Ldmk</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" id="townCheckbox" class="overlay-checkbox">
                <span>Town</span>
            </label>
        </div>
        <div class="credit-link">
            <a href="https://www.weather.gov.sg" target="_blank" rel="noopener noreferrer">Thanks to: weather.gov.sg</a>
        </div>
        <div class="location-error-message" id="locationErrorMessage">
            Ëé∑Âèñ‰ΩçÁΩÆ‰ø°ÊÅØÂ§±Ë¥•ÔºåËØ∑ÂèÇËÄÉ<a href="https://support.google.com/maps/?hl=zh-CN&p=browser_lp" target="_blank" rel="noopener noreferrer">ËøôÈáå</a>„ÄÇ
        </div>
    </div>

    <script>
        class WeatherMap {
            constructor() {
                this.baseMap = document.getElementById('baseMap');
                this.cloudOverlay = document.getElementById('cloudOverlay');
                this.timeSlider = document.getElementById('timeSlider');
                this.timeDisplay = document.getElementById('timeDisplay');
                this.dateText = document.getElementById('dateText');
                this.timeText = document.getElementById('timeText');
                this.datePicker = document.getElementById('datePicker');
                this.locationErrorMessage = document.getElementById('locationErrorMessage');
                this.playBtn = document.getElementById('playBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.historyBtn = document.getElementById('historyBtn');
                this.loading = document.getElementById('loading');
                this.errorMessage = document.getElementById('errorMessage');
                
                // Âè†Âä†Â±ÇÂÖÉÁ¥†
                this.mrtOverlay = document.getElementById('mrtOverlay');
                this.hiwOverlay = document.getElementById('hiwOverlay');
                this.ldmkOverlay = document.getElementById('ldmkOverlay');
                this.townOverlay = document.getElementById('townOverlay');
                
                // Â§çÈÄâÊ°ÜÂÖÉÁ¥†
                this.mrtCheckbox = document.getElementById('mrtCheckbox');
                this.hiwCheckbox = document.getElementById('hiwCheckbox');
                this.ldmkCheckbox = document.getElementById('ldmkCheckbox');
                this.townCheckbox = document.getElementById('townCheckbox');
                
                // Áî®Êà∑‰ΩçÁΩÆÂÖÉÁ¥†
                this.userLocation = document.getElementById('userLocation');
                
                // Âú∞ÂõæÂèÇÊï∞
                this.mapBounds = {
                    topLeft: { lat: 1.477355, lng: 103.555426 },
                    bottomRight: { lat: 1.158784, lng: 104.132921 },
                    width: 853,
                    height: 479
                };
                
                this.isPlaying = false;
                this.playInterval = null;
                this.currentTimeIndex = 24; // ÈªòËÆ§ÊòæÁ§∫ÊúÄÊñ∞Êó∂Èó¥
                this.isHistoryMode = false; // ÊòØÂê¶‰∏∫ÂéÜÂè≤Ê®°Âºè
                this.selectedDate = null; // ÈÄâÊã©ÁöÑÊó•Êúü
                
                // ËÆæÁΩÆÊó•ÊúüÈÄâÊã©Âô®ÁöÑÊúÄÂ§ßÂÄº‰∏∫‰ªäÂ§©ÔºàGMT+8 Êñ∞Âä†Âù°Êó∂Èó¥Ôºâ
                const todayStr = new Date().toLocaleDateString('en-CA', { 
                    timeZone: 'Asia/Singapore',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                this.datePicker.max = todayStr;
                // ËÆæÁΩÆÊó•ÊúüÈÄâÊã©Âô®ÁöÑÊúÄÂ∞èÂÄº‰∏∫2025-11-01
                this.datePicker.min = '2025-11-01';
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadCurrentWeather();
                this.updateTimeDisplay();
                this.getUserLocation();
            }

            setupEventListeners() {
                this.timeSlider.addEventListener('input', (e) => {
                    this.currentTimeIndex = parseInt(e.target.value);
                    this.updateTimeDisplay();
                    this.loadWeatherImage();
                });

                this.playBtn.addEventListener('click', () => {
                    this.startPlayback();
                });

                this.pauseBtn.addEventListener('click', () => {
                    this.stopPlayback();
                });

                this.historyBtn.addEventListener('click', () => {
                    this.toggleHistoryMode();
                });

                this.datePicker.addEventListener('change', (e) => {
                    this.onDateSelected(e.target.value);
                });

                // Âè†Âä†Â±ÇÂ§çÈÄâÊ°Ü‰∫ã‰ª∂
                this.mrtCheckbox.addEventListener('change', () => {
                    this.toggleOverlay(this.mrtOverlay, this.mrtCheckbox.checked, 'https://www.weather.gov.sg/wp-content/themes/wiptheme/images/MRT.png');
                });

                this.hiwCheckbox.addEventListener('change', () => {
                    this.toggleOverlay(this.hiwOverlay, this.hiwCheckbox.checked, 'https://www.weather.gov.sg/wp-content/themes/wiptheme/images/expressway.png');
                });

                this.ldmkCheckbox.addEventListener('change', () => {
                    this.toggleOverlay(this.ldmkOverlay, this.ldmkCheckbox.checked, 'https://www.weather.gov.sg/wp-content/themes/wiptheme/images/Landmarks.png');
                });

                this.townCheckbox.addEventListener('change', () => {
                    this.toggleOverlay(this.townOverlay, this.townCheckbox.checked, 'https://www.weather.gov.sg/wp-content/themes/wiptheme/images/SG-Township.png');
                });

                // Â§ÑÁêÜÂõæÁâáÂä†ËΩΩÈîôËØØ
                this.cloudOverlay.addEventListener('error', () => {
                    this.showError();
                });

                this.cloudOverlay.addEventListener('load', () => {
                    this.hideLoading();
                });

                // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñÔºåÈáçÊñ∞ËÆ°ÁÆóÁî®Êà∑‰ΩçÁΩÆ
                window.addEventListener('resize', () => {
                    this.updateUserLocationPosition();
                });
            }

            // Ëé∑ÂèñÊó∂Èó¥ËåÉÂõ¥
            getTimeRange() {
                const times = [];
                
                if (this.isHistoryMode && this.selectedDate) {
                    // ÂéÜÂè≤Ê®°ÂºèÔºöÁîüÊàêÈÄâ‰∏≠Êó•ÊúüÂΩìÂ§©ÁöÑÊâÄÊúâÊó∂Èó¥ÁÇπÔºà00:00-23:55ÔºåÊØè5ÂàÜÈíü‰∏Ä‰∏™Ôºâ
                    const selectedDateObj = new Date(this.selectedDate + 'T00:00:00');
                    const isToday = this.isSelectedDateToday();
                    
                    if (isToday) {
                        // Â¶ÇÊûúÊòØ‰ªäÂ§©ÔºåÂè™ÁîüÊàêÂà∞ÂΩìÂâçÊó∂Èó¥ÔºàGMT+8 Êñ∞Âä†Âù°Êó∂Èó¥Ôºâ
                        const now = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Singapore' }));
                        const currentMinutes = now.getHours() * 60 + Math.floor(now.getMinutes() / 5) * 5;
                        const maxIndex = currentMinutes / 5;
                        
                        for (let i = 0; i <= maxIndex; i++) {
                            const time = new Date(selectedDateObj);
                            time.setHours(Math.floor(i * 5 / 60));
                            time.setMinutes((i * 5) % 60);
                            times.push(time);
                        }
                    } else {
                        // ÂéÜÂè≤Êó•ÊúüÔºöÁîüÊàêÂÖ®Â§©ÁöÑÊó∂Èó¥ÁÇπ
                        for (let i = 0; i < 288; i++) { // 24Â∞èÊó∂ * 12‰∏™5ÂàÜÈíüÈó¥Èöî = 288
                            const time = new Date(selectedDateObj);
                            time.setHours(Math.floor(i * 5 / 60));
                            time.setMinutes((i * 5) % 60);
                            times.push(time);
                        }
                    }
                } else {
                    // ÂÆûÊó∂Ê®°ÂºèÔºöÁîüÊàêËøáÂéª2Â∞èÊó∂ÁöÑÊó∂Èó¥ÁÇπÔºåÊØè5ÂàÜÈíü‰∏Ä‰∏™ÔºàGMT+8 Êñ∞Âä†Âù°Êó∂Èó¥Ôºâ
                    const now = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Singapore' }));
                    for (let i = 0; i <= 24; i++) {
                        const time = new Date(now.getTime() - (i * 5 * 60 * 1000));
                        times.push(time);
                    }
                    return times.reverse(); // ‰ªéÊúÄÊó©Âà∞ÊúÄÊñ∞
                }
                
                return times; // ÂéÜÂè≤Ê®°ÂºèÂ∑≤ÁªèÊòØ‰ªéÊó©Âà∞ÊôöÁöÑÈ°∫Â∫è
            }

            // Ê†ºÂºèÂåñÊó∂Èó¥‰∏∫URLÊâÄÈúÄÁöÑÊ†ºÂºè
            formatTimeForUrl(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                return `${year}${month}${day}${hours}${minutes}${seconds}`;
            }

            // ÁîüÊàê‰∫ëÂõæURL
            generateCloudImageUrl(timeString, date) {
                if (this.isHistoryMode && this.selectedDate && !this.isSelectedDateToday()) {
                    // ÂéÜÂè≤Êó•ÊúüÔºö‰ªéËá™Â∑±ÁöÑÊúçÂä°Âô®Ëé∑Âèñ
                    // timeStringÊ†ºÂºèÔºöYYYYMMDDHHMMSSÔºåÈúÄË¶ÅÊèêÂèñYYYYMMDDÂíåHHMM
                    const dateStr = timeString.substring(0, 8); // YYYYMMDD
                    const timeStr = timeString.substring(8, 12); // HHMM
                    return `https://luy.li/data/weather_images/${dateStr}/${dateStr}${timeStr}.png`;
                } else {
                    // ÂÆûÊó∂Ê®°ÂºèÊàñ‰ªäÂ§©Ôºö‰ªéweather.gov.sgËé∑Âèñ
                    return `https://www.weather.gov.sg/files/rainarea/50km/v2/dpsri_70km_${timeString}00dBR.dpsri.png`;
                }
            }

            // Âä†ËΩΩÂ§©Ê∞îÂõæÁâá
            loadWeatherImage() {
                this.loadWeatherImageWithFallback(this.currentTimeIndex);
            }

            // Â∏¶ÂõûÈÄÄÊú∫Âà∂ÁöÑÂõæÁâáÂä†ËΩΩ
            loadWeatherImageWithFallback(timeIndex) {
                const times = this.getTimeRange();
                const selectedTime = times[timeIndex];
                // ÂΩí‰∏ÄÂåñÂà∞5ÂàÜÈíüÊó∂Èó¥ÁÇπÔºåÊØîÂ¶Ç 2:00„ÄÅ2:05„ÄÅ2:10
                selectedTime.setMinutes(Math.floor(selectedTime.getMinutes() / 5) * 5, 0, 0);
                const timeString = this.formatTimeForUrl(selectedTime);
                const imageUrl = this.generateCloudImageUrl(timeString, selectedTime);
                
                this.showLoading();
                this.hideError();
                
                // È¢ÑÂä†ËΩΩÂõæÁâá
                const img = new Image();
                img.onload = () => {
                    this.cloudOverlay.src = imageUrl;
                    this.hideLoading();
                };
                img.onerror = () => {
                    // Â¶ÇÊûúÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∞ùËØï‰∏ä‰∏Ä‰∏™5ÂàÜÈíüÔºàÂè™Â∞ùËØï‰∏ÄÊ¨°Ôºâ
                    if (timeIndex > 0) {
                        console.log('Â∞ùËØïÂä†ËΩΩ‰∏ä‰∏Ä‰∏™5ÂàÜÈíüÂõæÁâá', timeIndex - 1);
                        this.tryPreviousImage(timeIndex - 1);
                    } else {
                        this.showError();
                    }
                };
                img.src = imageUrl;
            }

            // Â∞ùËØïÂä†ËΩΩ‰∏ä‰∏Ä‰∏™5ÂàÜÈíüÁöÑÂõæÁâá
            tryPreviousImage(prevTimeIndex) {
                const times = this.getTimeRange();
                const selectedTime = times[prevTimeIndex];
                // ÂΩí‰∏ÄÂåñÂà∞5ÂàÜÈíüÊó∂Èó¥ÁÇπ
                selectedTime.setMinutes(Math.floor(selectedTime.getMinutes() / 5) * 5, 0, 0);
                const timeString = this.formatTimeForUrl(selectedTime);
                const imageUrl = this.generateCloudImageUrl(timeString, selectedTime);
                
                const img = new Image();
                img.onload = () => {
                    this.cloudOverlay.src = imageUrl;
                    this.hideLoading();
                };
                img.onerror = () => {
                    this.showError();
                };
                img.src = imageUrl;
            }

            // Âä†ËΩΩÂΩìÂâçÂ§©Ê∞î
            loadCurrentWeather() {
                // ÂÆûÊó∂Ê®°ÂºèÔºöËøáÂéª2Â∞èÊó∂ÂÖ±25‰∏™Êó∂Èó¥ÁÇπÔºàÁ¥¢Âºï0-24Ôºâ
                this.timeSlider.min = 0;
                this.timeSlider.max = 24;
                this.currentTimeIndex = 24; // ÊúÄÊñ∞Êó∂Èó¥
                this.timeSlider.value = 24;
                this.loadWeatherImage();
            }

            // Êõ¥Êñ∞Êó∂Èó¥ÊòæÁ§∫
            updateTimeDisplay() {
                const times = this.getTimeRange();
                const selectedTime = times[this.currentTimeIndex];
                // ÂΩí‰∏ÄÂåñÂà∞5ÂàÜÈíüÊó∂Èó¥ÁÇπ
                selectedTime.setMinutes(Math.floor(selectedTime.getMinutes() / 5) * 5, 0, 0);
                
                // Êõ¥Êñ∞Êó•ÊúüÈÉ®ÂàÜÔºàGMT+8 Êñ∞Âä†Âù°Êó∂Èó¥ÔºåËá™ÈÄÇÂ∫îÁî®Êà∑ËØ≠Ë®ÄËÆæÁΩÆÔºâ
                const dateString = selectedTime.toLocaleDateString(undefined, {
                    timeZone: 'Asia/Singapore',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                this.dateText.textContent = dateString;
                
                // Êõ¥Êñ∞Êó∂Èó¥ÈÉ®ÂàÜÔºàGMT+8 Êñ∞Âä†Âù°Êó∂Èó¥ÔºåËá™ÈÄÇÂ∫îÁî®Êà∑ËØ≠Ë®ÄËÆæÁΩÆÔºâ
                const timeString = selectedTime.toLocaleTimeString(undefined, {
                    timeZone: 'Asia/Singapore',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                this.timeText.textContent = timeString;
            }

            // ÂàáÊç¢ÂéÜÂè≤Ê®°Âºè
            toggleHistoryMode() {
                this.isHistoryMode = !this.isHistoryMode;
                
                if (this.isHistoryMode) {
                    // ÂàáÊç¢Âà∞ÂéÜÂè≤Ê®°ÂºèÔºöÊòæÁ§∫Êó•ÊúüÈÄâÊã©Âô®ÔºåÈöêËóèÊó•ÊúüÊñáÊú¨ÔºàÊó∂Èó¥ÈÉ®ÂàÜÂßãÁªàÊòæÁ§∫Ôºâ
                    this.dateText.style.display = 'none';
                    this.datePicker.style.display = 'block';
                    // ËÆæÁΩÆÈªòËÆ§Êó•Êúü‰∏∫‰ªäÂ§©ÔºàGMT+8 Êñ∞Âä†Âù°Êó∂Èó¥Ôºâ
                    const todayStr = new Date().toLocaleDateString('en-CA', { 
                        timeZone: 'Asia/Singapore',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    console.log('GMT+8 Today:', todayStr);
                    this.datePicker.value = todayStr;
                    this.onDateSelected(todayStr);
                } else {
                    // ÂàáÊç¢ÂõûÂÆûÊó∂Ê®°ÂºèÔºöÈöêËóèÊó•ÊúüÈÄâÊã©Âô®ÔºåÊòæÁ§∫Êó•ÊúüÊñáÊú¨ÔºàÊó∂Èó¥ÈÉ®ÂàÜÂßãÁªàÊòæÁ§∫Ôºâ
                    this.dateText.style.display = 'block';
                    this.datePicker.style.display = 'none';
                    this.selectedDate = null;
                    this.stopPlayback();
                    this.loadCurrentWeather();
                }
            }

            // Êó•ÊúüÈÄâÊã©Â§ÑÁêÜ
            onDateSelected(dateString) {
                this.selectedDate = dateString;
                this.stopPlayback();
                
                const times = this.getTimeRange();
                const maxIndex = times.length - 1;
                
                // Êõ¥Êñ∞ÊªëÂùóËåÉÂõ¥
                this.timeSlider.min = 0;
                this.timeSlider.max = maxIndex;
                
                // Â¶ÇÊûúÊòØ‰ªäÂ§©ÔºåÊòæÁ§∫Âà∞ÂΩìÂâçÊó∂Èó¥ÔºõÂ¶ÇÊûúÊòØÂéÜÂè≤Êó•ÊúüÔºåÊòæÁ§∫Âà∞23:55
                if (this.isSelectedDateToday()) {
                    // ‰ªäÂ§©ÔºöÊòæÁ§∫ÊúÄÊñ∞Êó∂Èó¥
                    this.currentTimeIndex = maxIndex;
                } else {
                    // ÂéÜÂè≤Êó•ÊúüÔºöÊòæÁ§∫ÊúÄÂêéÊó∂Èó¥Ôºà23:55Ôºâ
                    this.currentTimeIndex = maxIndex;
                }
                
                this.timeSlider.value = this.currentTimeIndex;
                this.updateTimeDisplay();
                this.loadWeatherImage();
            }

            // Ê£ÄÊü•ÈÄâÊã©ÁöÑÊó•ÊúüÊòØÂê¶‰∏∫‰ªäÂ§©ÔºàGMT+8 Êñ∞Âä†Âù°Êó∂Èó¥Ôºâ
            isSelectedDateToday() {
                if (!this.selectedDate) return false;
                const todayStr = new Date().toLocaleDateString('en-CA', { 
                    timeZone: 'Asia/Singapore',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                return this.selectedDate === todayStr;
            }

            // ÂºÄÂßãÊí≠Êîæ
            startPlayback() {
                if (this.isPlaying) return;
                
                // ÂÖàËÆæÁΩÆÂà∞Êó∂Èó¥ËΩ¥ÂºÄÂßã‰ΩçÁΩÆ
                this.currentTimeIndex = 0;
                this.timeSlider.value = 0;
                this.updateTimeDisplay();
                this.loadWeatherImage();
                
                this.isPlaying = true;
                this.playBtn.style.display = 'none';
                this.pauseBtn.style.display = 'inline-block';
                
                const times = this.getTimeRange();
                const maxIndex = times.length - 1;
                
                this.playInterval = setInterval(() => {
                    if (this.currentTimeIndex < maxIndex) {
                        this.currentTimeIndex++;
                        this.timeSlider.value = this.currentTimeIndex;
                        this.updateTimeDisplay();
                        this.loadWeatherImage();
                    } else {
                        this.stopPlayback();
                    }
                }, 150); // ÊØè150msÊõ¥Êñ∞‰∏ÄÊ¨°ÔºåÂàõÈÄ†ÊµÅÁïÖÁöÑÊí≠ÊîæÊïàÊûú
            }

            // ÂÅúÊ≠¢Êí≠Êîæ
            stopPlayback() {
                this.isPlaying = false;
                this.playBtn.style.display = 'inline-block';
                this.pauseBtn.style.display = 'none';
                
                if (this.playInterval) {
                    clearInterval(this.playInterval);
                    this.playInterval = null;
                }
            }

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            showLoading() {
                this.loading.style.display = 'block';
            }

            // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
            hideLoading() {
                this.loading.style.display = 'none';
            }

            // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
            showError() {
                this.errorMessage.style.display = 'block';
                this.hideLoading();
            }

            // ÈöêËóèÈîôËØØ‰ø°ÊÅØ
            hideError() {
                this.errorMessage.style.display = 'none';
            }

            // ÂàáÊç¢Âè†Âä†Â±ÇÊòæÁ§∫
            toggleOverlay(overlayElement, show, imageUrl) {
                if (show) {
                    // Âè™ÊúâÂú®ÈúÄË¶ÅÊòæÁ§∫‰∏îËøòÊ≤°ÊúâÂä†ËΩΩËøáÂõæÁâáÊó∂ÊâçÂä†ËΩΩ
                    if (!overlayElement.src) {
                        overlayElement.src = imageUrl;
                    }
                    overlayElement.style.display = 'block';
                } else {
                    overlayElement.style.display = 'none';
                }
            }

            // Ëé∑ÂèñÁî®Êà∑‰ΩçÁΩÆ
            getUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.userPosition = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            this.updateUserLocationPosition();
                        },
                        (error) => {
                            console.log('Ëé∑Âèñ‰ΩçÁΩÆÂ§±Ë¥•:', error.message);
                            // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                            this.locationErrorMessage.style.display = 'block';
                            // Ë∞ÉËØï
                            // this.userPosition = { lat: 1.299956, lng: 103.787612 };
                            // this.updateUserLocationPosition();
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000 // 5ÂàÜÈíüÁºìÂ≠ò
                        }
                    );
                }
            }

            // Êõ¥Êñ∞Áî®Êà∑‰ΩçÁΩÆÊòæÁ§∫
            updateUserLocationPosition() {
                if (!this.userPosition) return;

                // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Âú®Âú∞ÂõæËåÉÂõ¥ÂÜÖ
                if (this.isUserInMapBounds()) {
                    const position = this.convertLatLngToPixel(this.userPosition.lat, this.userPosition.lng);
                    this.userLocation.style.left = position.x + 'px';
                    this.userLocation.style.top = position.y + 'px';
                    this.userLocation.style.display = 'block';
                } else {
                    this.userLocation.style.display = 'none';
                }
            }

            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Âú®Âú∞ÂõæËåÉÂõ¥ÂÜÖ
            isUserInMapBounds() {
                const { lat, lng } = this.userPosition;
                const { topLeft, bottomRight } = this.mapBounds;
                
                return lat >= bottomRight.lat && lat <= topLeft.lat &&
                       lng >= topLeft.lng && lng <= bottomRight.lng;
            }

            // Â∞ÜÁªèÁ∫¨Â∫¶ËΩ¨Êç¢‰∏∫ÂÉèÁ¥†ÂùêÊ†á
            convertLatLngToPixel(lat, lng) {
                const { topLeft, bottomRight, width, height } = this.mapBounds;
                
                // ËÆ°ÁÆóÂú®Âú∞ÂõæÂéüÂßãÂ∞∫ÂØ∏‰∏≠ÁöÑÁõ∏ÂØπ‰ΩçÁΩÆ
                const latRatio = (topLeft.lat - lat) / (topLeft.lat - bottomRight.lat);
                const lngRatio = (lng - topLeft.lng) / (bottomRight.lng - topLeft.lng);
                
                const originalX = lngRatio * width;
                const originalY = latRatio * height;
                
                // Ëé∑ÂèñÂΩìÂâçÂ∫ïÂõæÁöÑÂÆûÈôÖÊòæÁ§∫Â∞∫ÂØ∏Âíå‰ΩçÁΩÆ
                const baseMapRect = this.baseMap.getBoundingClientRect();
                const containerRect = this.baseMap.parentElement.getBoundingClientRect();
                
                // ËÆ°ÁÆóÂ∫ïÂõæÂú®ÂÆπÂô®‰∏≠ÁöÑÂÅèÁßªÈáèÔºàËÄÉËôëobject-fit: containÁöÑÂ±Ö‰∏≠ÊïàÊûúÔºâ
                const containerAspect = containerRect.width / containerRect.height;
                const mapAspect = width / height;
                
                let offsetX = 0;
                let offsetY = 0;
                let scale = 1;
                
                if (containerAspect > mapAspect) {
                    // ÂÆπÂô®Êõ¥ÂÆΩÔºåÂõæÁâáÂú®ÂûÇÁõ¥ÊñπÂêëÂ°´Êª°ÔºåÊ∞¥Âπ≥ÊñπÂêëÂ±Ö‰∏≠
                    scale = containerRect.height / height;
                    offsetX = (containerRect.width - width * scale) / 2;
                } else {
                    // ÂÆπÂô®Êõ¥È´òÔºåÂõæÁâáÂú®Ê∞¥Âπ≥ÊñπÂêëÂ°´Êª°ÔºåÂûÇÁõ¥ÊñπÂêëÂ±Ö‰∏≠
                    scale = containerRect.width / width;
                    offsetY = (containerRect.height - height * scale) / 2;
                }
                
                // ËÆ°ÁÆóÂú®ÂÆπÂô®‰∏≠ÁöÑÂÆûÈôÖ‰ΩçÁΩÆ
                const actualX = originalX * scale + offsetX;
                const actualY = originalY * scale + offsetY;
                
                return { x: actualX, y: actualY };
            }
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            new WeatherMap();
        });

        // Â§ÑÁêÜÁ™óÂè£Â§ßÂ∞èÂèòÂåñ
        window.addEventListener('resize', () => {
            // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÂìçÂ∫îÂºèÂ§ÑÁêÜÈÄªËæë
        });
    </script>
</body>
</html>
