<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Clipper for Print</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Georgia, Serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        /* é¡¶éƒ¨è¾“å…¥æ æ ·å¼ */
        .input-area {
            max-width: 800px;
            margin: 0 auto 30px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-width: 200px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        button:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        button:disabled {
            background-color: #ccc;
        }

        /* æ¸…ç†æ¨¡å¼æŒ‰é’® */
        #cleanBtn {
            background-color: #fd7e14;
        }
        
        #cleanBtn.active {
            background-color: #dc3545;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(220, 53, 69, 0); }
        }

        /* æ¸…ç†æ¨¡å¼æç¤ºæ¡ */
        .clean-mode-banner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .clean-mode-banner.show {
            display: block;
        }
        
        .clean-mode-banner span {
            margin-right: 15px;
        }
        
        .clean-mode-banner button {
            background: white;
            color: #dc3545;
            padding: 6px 16px;
            font-size: 14px;
        }

        /* é˜…è¯»æ¨¡å¼/æ‰“å°é¢„è§ˆå®¹å™¨ */
        #reader-content {
            max-width: 210mm; /* A4 å®½åº¦ */
            min-height: 297mm;
            margin: 0 auto;
            background: white;
            padding: 20mm; /* æ‰“å°è¾¹è· */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            box-sizing: border-box; /* åŒ…å« padding */
        }

        /* æ¸…ç†æ¨¡å¼ä¸‹çš„å†…å®¹åŒºåŸŸ */
        body.clean-mode #reader-content {
            margin-top: 60px;
        }

        /* æ¸…ç†æ¨¡å¼ä¸‹å…ƒç´ çš„é«˜äº®æ•ˆæœ */
        body.clean-mode #reader-content *:hover {
            outline: 3px solid #dc3545 !important;
            outline-offset: 2px;
            cursor: crosshair !important;
            background-color: rgba(220, 53, 69, 0.1) !important;
        }
        
        /* å…ƒç´ åˆ é™¤åŠ¨ç”» */
        .element-removing {
            animation: fadeOutShrink 0.3s ease forwards;
        }
        
        @keyframes fadeOutShrink {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.8); height: 0; margin: 0; padding: 0; }
        }

        /* ç›¸ä¼¼å…ƒç´ é«˜äº® */
        .similar-element-highlight {
            outline: 3px dashed #fd7e14 !important;
            outline-offset: 2px;
            background-color: rgba(253, 126, 20, 0.15) !important;
        }

        /* æ‰¹é‡æ¸…ç†ç¡®è®¤å¯¹è¯æ¡† */
        .batch-clean-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px 32px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 2000;
            text-align: center;
            max-width: 400px;
        }
        
        .batch-clean-dialog.show {
            display: block;
        }
        
        .batch-clean-dialog h3 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 18px;
        }
        
        .batch-clean-dialog p {
            margin: 0 0 20px 0;
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .batch-clean-dialog .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .batch-clean-dialog button {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 6px;
        }
        
        .batch-clean-dialog .btn-batch {
            background-color: #dc3545;
        }
        
        .batch-clean-dialog .btn-single {
            background-color: #fd7e14;
        }
        
        .batch-clean-dialog .btn-cancel {
            background-color: #6c757d;
        }
        
        /* å¯¹è¯æ¡†é®ç½© */
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
        }
        
        .dialog-overlay.show {
            display: block;
        }

        /* é˜…è¯»å†…å®¹æ’ç‰ˆä¼˜åŒ– */
        #reader-content h1 {
            font-size: 24pt;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        #reader-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px auto;
        }

        #reader-content p {
            font-size: 14pt; /* å¤§å­—ä½“ï¼Œé€‚åˆé˜…è¯» */
            line-height: 1.6;
            margin-bottom: 15px;
            text-align: justify;
        }
        
        #reader-content pre {
            white-space: pre-wrap;
            background: #eee;
            padding: 10px;
            border-radius: 5px;
        }

        /* ä¿ç•™åŸå§‹æ–‡ç« çš„å­—ä½“æ ·å¼ */
        #reader-content strong,
        #reader-content b {
            font-weight: bold;
        }

        #reader-content em,
        #reader-content i {
            font-style: italic;
        }

        #reader-content u {
            text-decoration: underline;
        }

        #reader-content s,
        #reader-content del,
        #reader-content strike {
            text-decoration: line-through;
        }

        #reader-content mark {
            background-color: #ffeb3b;
            padding: 0 2px;
        }

        #reader-content sub {
            vertical-align: sub;
            font-size: smaller;
        }

        #reader-content sup {
            vertical-align: super;
            font-size: smaller;
        }

        #reader-content code {
            font-family: "SF Mono", Consolas, "Liberation Mono", Menlo, monospace;
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        #reader-content blockquote {
            border-left: 4px solid #ccc;
            margin: 20px 0;
            padding: 10px 20px;
            background-color: #f9f9f9;
            font-style: italic;
            color: #555;
        }

        /* ç¡®ä¿ blockquote å†…æ‰€æœ‰å…ƒç´ ç»§æ‰¿æ–œä½“ */
        #reader-content blockquote * {
            font-style: inherit;
        }

        /* figure å¼•ç”¨å—æ ·å¼ï¼ˆå¸¸è§äºæ–°é—»ç½‘ç«™ï¼‰ */
        #reader-content figure {
            margin: 20px 0;
            padding: 0;
        }

        #reader-content figure blockquote {
            margin: 0;
        }

        #reader-content figcaption,
        #reader-content cite {
            font-style: italic;
            color: #666;
            font-size: 0.9em;
        }

        /* ä¸€äº›ç½‘ç«™ä½¿ç”¨ aside ä½œä¸ºå¼•ç”¨å— */
        #reader-content aside {
            border-left: 4px solid #ccc;
            margin: 20px 0;
            padding: 10px 20px;
            background-color: #f9f9f9;
            font-style: italic;
            color: #555;
        }

        #reader-content a {
            color: #007bff;
            text-decoration: underline;
        }

        /* ä¿ç•™æ ‡é¢˜å±‚çº§æ ·å¼ */
        #reader-content h2 {
            font-size: 20pt;
            font-weight: bold;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        #reader-content h3 {
            font-size: 16pt;
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 12px;
        }

        #reader-content h4 {
            font-size: 14pt;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        #reader-content h5,
        #reader-content h6 {
            font-size: 12pt;
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 8px;
        }

        /* åˆ—è¡¨æ ·å¼ */
        #reader-content ul,
        #reader-content ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        #reader-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        /* --- æ‰“å°ä¸“ç”¨æ ·å¼ --- */
        @media print {
            body {
                background: white;
                margin: 0;
                padding: 0;
            }
            
            /* æ‰“å°æ—¶éšè—è¾“å…¥æ¡†å’ŒèƒŒæ™¯ */
            .input-area, .no-print, .clean-mode-banner {
                display: none !important;
            }

            #reader-content {
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            
            /* å¼ºåˆ¶èƒŒæ™¯æ‰“å°ï¼ˆå¦‚æœéœ€è¦æ‰“å°å›¾ç‰‡èƒŒæ™¯ï¼‰ */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>
<body>

    <!-- æ¸…ç†æ¨¡å¼æç¤ºæ¡ -->
    <div class="clean-mode-banner" id="cleanModeBanner">
        <span>ğŸ§¹ æ¸…ç†æ¨¡å¼å·²å¼€å¯ - ç‚¹å‡»é¡µé¢ä¸­è¦ç§»é™¤çš„å…ƒç´ </span>
        <button onclick="toggleCleanMode()">å®Œæˆæ¸…ç†</button>
    </div>

    <!-- æ‰¹é‡æ¸…ç†å¯¹è¯æ¡†é®ç½© -->
    <div class="dialog-overlay" id="dialogOverlay"></div>
    
    <!-- æ‰¹é‡æ¸…ç†ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="batch-clean-dialog" id="batchCleanDialog">
        <h3>ğŸ” å‘ç°ç›¸ä¼¼å…ƒç´ </h3>
        <p id="batchCleanMsg">å‘ç° X ä¸ªç±»ä¼¼å…ƒç´ ï¼Œæ˜¯å¦æ‰¹é‡æ¸…ç†ï¼Ÿ</p>
        <div class="btn-group">
            <button class="btn-batch" onclick="confirmBatchClean(true)">æ‰¹é‡æ¸…ç†å…¨éƒ¨</button>
            <button class="btn-single" onclick="confirmBatchClean(false)">ä»…æ¸…ç†å½“å‰</button>
            <button class="btn-cancel" onclick="cancelBatchClean()">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="urlInput" placeholder="è¾“å…¥æ–‡ç«  URL (ä¾‹å¦‚: https://...)" />
        <button id="goBtn" onclick="fetchArticle()">æå–å¹¶é¢„è§ˆ</button>
        <button id="cleanBtn" onclick="toggleCleanMode()">ğŸ§¹ æ¸…ç†å…ƒç´ </button>
        <button onclick="window.print()" style="background-color: #28a745;">æ‰“å° / PDF</button>
    </div>

    <div id="reader-content">
        <div style="text-align: center; color: #888; margin-top: 50px;">
            è¯·åœ¨ä¸Šæ–¹è¾“å…¥é“¾æ¥ä»¥å¼€å§‹...
        </div>
    </div>

    <script>
        // æ¸…ç†æ¨¡å¼çŠ¶æ€
        let isCleanMode = false;
        let pendingTarget = null;      // å¾…å¤„ç†çš„ç›®æ ‡å…ƒç´ 
        let similarElements = [];       // ç›¸ä¼¼å…ƒç´ åˆ—è¡¨
        
        // åˆ‡æ¢æ¸…ç†æ¨¡å¼
        function toggleCleanMode() {
            isCleanMode = !isCleanMode;
            const body = document.body;
            const cleanBtn = document.getElementById('cleanBtn');
            const banner = document.getElementById('cleanModeBanner');
            const contentDiv = document.getElementById('reader-content');
            
            if (isCleanMode) {
                body.classList.add('clean-mode');
                cleanBtn.classList.add('active');
                cleanBtn.textContent = 'âŒ é€€å‡ºæ¸…ç†';
                banner.classList.add('show');
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                contentDiv.addEventListener('click', handleElementClick);
            } else {
                body.classList.remove('clean-mode');
                cleanBtn.classList.remove('active');
                cleanBtn.textContent = 'ğŸ§¹ æ¸…ç†å…ƒç´ ';
                banner.classList.remove('show');
                
                // ç§»é™¤ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                contentDiv.removeEventListener('click', handleElementClick);
                
                // æ¸…ç†å¯¹è¯æ¡†çŠ¶æ€
                cancelBatchClean();
            }
        }
        
        // è·å–å…ƒç´ çš„ç‰¹å¾ç­¾åï¼ˆç”¨äºæ¯”è¾ƒç›¸ä¼¼æ€§ï¼‰
        function getElementSignature(el) {
            const tagName = el.tagName.toLowerCase();
            const className = el.className.replace(/\s*(similar-element-highlight|element-removing)\s*/g, '').trim();
            const parentTag = el.parentElement ? el.parentElement.tagName.toLowerCase() : '';
            
            // è·å–å…³é”®çš„è®¡ç®—æ ·å¼
            const computedStyle = window.getComputedStyle(el);
            const styleSignature = [
                computedStyle.fontSize,
                computedStyle.fontWeight,
                computedStyle.fontStyle,      // æ–œä½“/æ­£å¸¸
                computedStyle.textDecoration, // ä¸‹åˆ’çº¿/åˆ é™¤çº¿ç­‰
                computedStyle.color,
                computedStyle.display,
                computedStyle.padding,
                computedStyle.margin
            ].join('|');
            
            // æ£€æŸ¥å†…éƒ¨ç»“æ„ç‰¹å¾
            const hasItalicChild = el.querySelector('em, i') !== null;
            const hasBoldChild = el.querySelector('strong, b') !== null;
            const hasLinkChild = el.querySelector('a') !== null;
            const childTagsSignature = Array.from(el.children).map(c => c.tagName.toLowerCase()).join(',');
            
            // æ–‡æœ¬å†…å®¹é•¿åº¦èŒƒå›´ï¼ˆçŸ­/ä¸­/é•¿ï¼‰
            const textLength = el.textContent.trim().length;
            const lengthCategory = textLength < 50 ? 'short' : (textLength < 200 ? 'medium' : 'long');
            
            return `${tagName}::${className}::${parentTag}::${styleSignature}::${hasItalicChild}::${hasBoldChild}::${hasLinkChild}::${childTagsSignature}::${lengthCategory}`;
        }
        
        // æŸ¥æ‰¾ç›¸ä¼¼å…ƒç´ 
        function findSimilarElements(target) {
            const contentDiv = document.getElementById('reader-content');
            const targetSignature = getElementSignature(target);
            const allElements = contentDiv.querySelectorAll('*');
            const similar = [];
            
            allElements.forEach(el => {
                if (el !== target && !el.classList.contains('element-removing')) {
                    const elSignature = getElementSignature(el);
                    if (elSignature === targetSignature) {
                        similar.push(el);
                    }
                }
            });
            
            return similar;
        }
        
        // é«˜äº®ç›¸ä¼¼å…ƒç´ 
        function highlightSimilarElements(elements) {
            elements.forEach(el => {
                el.classList.add('similar-element-highlight');
            });
        }
        
        // æ¸…é™¤ç›¸ä¼¼å…ƒç´ é«˜äº®
        function clearSimilarHighlights() {
            document.querySelectorAll('.similar-element-highlight').forEach(el => {
                el.classList.remove('similar-element-highlight');
            });
        }
        
        // æ˜¾ç¤ºæ‰¹é‡æ¸…ç†å¯¹è¯æ¡†
        function showBatchCleanDialog(count) {
            const dialog = document.getElementById('batchCleanDialog');
            const overlay = document.getElementById('dialogOverlay');
            const msg = document.getElementById('batchCleanMsg');
            
            msg.textContent = `å‘ç° ${count} ä¸ªç±»ä¼¼å…ƒç´ ï¼Œæ˜¯å¦æ‰¹é‡æ¸…ç†ï¼Ÿ`;
            dialog.classList.add('show');
            overlay.classList.add('show');
        }
        
        // éšè—æ‰¹é‡æ¸…ç†å¯¹è¯æ¡†
        function hideBatchCleanDialog() {
            const dialog = document.getElementById('batchCleanDialog');
            const overlay = document.getElementById('dialogOverlay');
            
            dialog.classList.remove('show');
            overlay.classList.remove('show');
        }
        
        // ç§»é™¤å…ƒç´ ï¼ˆå¸¦åŠ¨ç”»ï¼‰
        function removeElement(el) {
            el.classList.add('element-removing');
            setTimeout(() => {
                el.remove();
            }, 300);
        }
        
        // ç¡®è®¤æ‰¹é‡æ¸…ç†
        function confirmBatchClean(batchMode) {
            if (pendingTarget) {
                removeElement(pendingTarget);
                
                if (batchMode && similarElements.length > 0) {
                    // æ‰¹é‡åˆ é™¤æ‰€æœ‰ç›¸ä¼¼å…ƒç´ 
                    similarElements.forEach((el, index) => {
                        // ç¨å¾®é”™å¼€åˆ é™¤æ—¶é—´ï¼Œäº§ç”Ÿè¿é”åŠ¨ç”»æ•ˆæœ
                        setTimeout(() => {
                            removeElement(el);
                        }, index * 50);
                    });
                }
            }
            
            // æ¸…ç†çŠ¶æ€
            clearSimilarHighlights();
            hideBatchCleanDialog();
            pendingTarget = null;
            similarElements = [];
        }
        
        // å–æ¶ˆæ‰¹é‡æ¸…ç†
        function cancelBatchClean() {
            clearSimilarHighlights();
            hideBatchCleanDialog();
            pendingTarget = null;
            similarElements = [];
        }
        
        // å¤„ç†å…ƒç´ ç‚¹å‡»ï¼ˆæ¸…ç†æ¨¡å¼ä¸‹ï¼‰
        function handleElementClick(e) {
            if (!isCleanMode) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const target = e.target;
            const contentDiv = document.getElementById('reader-content');
            
            // ä¸å…è®¸åˆ é™¤æ ¹å®¹å™¨
            if (target === contentDiv) return;
            
            // æŸ¥æ‰¾ç›¸ä¼¼å…ƒç´ 
            const similar = findSimilarElements(target);
            
            if (similar.length > 0) {
                // æ‰¾åˆ°ç›¸ä¼¼å…ƒç´ ï¼Œæ˜¾ç¤ºå¯¹è¯æ¡†
                pendingTarget = target;
                similarElements = similar;
                
                // é«˜äº®æ˜¾ç¤ºç›¸ä¼¼å…ƒç´ 
                highlightSimilarElements(similar);
                target.classList.add('similar-element-highlight');
                
                // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                showBatchCleanDialog(similar.length + 1); // +1 åŒ…å«å½“å‰é€‰ä¸­çš„å…ƒç´ 
            } else {
                // æ²¡æœ‰ç›¸ä¼¼å…ƒç´ ï¼Œç›´æ¥åˆ é™¤
                removeElement(target);
            }
        }
        
        // ESC é”®é€€å‡ºæ¸…ç†æ¨¡å¼æˆ–å–æ¶ˆå¯¹è¯æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (pendingTarget) {
                    // å¦‚æœæœ‰å¾…å¤„ç†çš„å…ƒç´ ï¼Œå…ˆå–æ¶ˆå¯¹è¯æ¡†
                    cancelBatchClean();
                } else if (isCleanMode) {
                    toggleCleanMode();
                }
            }
        });

        async function fetchArticle() {
            const url = document.getElementById('urlInput').value;
            const contentDiv = document.getElementById('reader-content');
            const btn = document.getElementById('goBtn');

            if (!url) return alert("è¯·è¾“å…¥ URL");
            
            // å¦‚æœåœ¨æ¸…ç†æ¨¡å¼ï¼Œå…ˆé€€å‡º
            if (isCleanMode) {
                toggleCleanMode();
            }

            // ç®€å•çš„åŠ è½½çŠ¶æ€
            btn.disabled = true;
            btn.innerText = "å¤„ç†ä¸­...";
            contentDiv.innerHTML = '<p style="text-align:center">æ­£åœ¨åˆ†æç½‘é¡µå¹¶æ¸…ç†å¹¿å‘Š...</p>';

            try {
                // è°ƒç”¨æˆ‘ä»¬åˆšæ‰å†™çš„ Node.js åç«¯
                // å‡è®¾åç«¯è¿è¡Œåœ¨ localhost:3000
                const res = await fetch(`http://localhost:3000/api/read?url=${encodeURIComponent(url)}`);
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                // æ›´æ–°é¡µé¢æ ‡é¢˜ä¸ºæ–‡ç« æ ‡é¢˜æˆ–URL
                document.title = url;

                // æ¸²æŸ“å†…å®¹
                contentDiv.innerHTML = `
                    <h1>${data.title}</h1>
                    ${data.byline ? `<p style="font-style:italic; color:#666">By ${data.byline}</p>` : ''}
                    <hr/>
                    ${data.content}
                `;

            } catch (err) {
                console.error(err);
                contentDiv.innerHTML = `<p style="color:red; text-align:center">æå–å¤±è´¥: ${err.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerText = "æå–å¹¶é¢„è§ˆ";
            }
        }
    </script>
</body>
</html>